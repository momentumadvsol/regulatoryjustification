<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsible Lending Justification Tool (RLJT)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for professional aesthetic */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 3px 10px -3px rgba(0, 0, 0, 0.05); }
        .input-group label { font-weight: 600; color: #1e293b; }
        .justification-output { white-space: pre-wrap; font-family: monospace; }
        /* XAI Visualization */
        .shap-positive { background-color: #d1fae5; color: #065f46; }
        .shap-negative { background-color: #fee2e2; color: #991b1b; }
        .bias-alert { background-color: #fef3c7; color: #b45309; border: 2px solid #f59e0b; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e40af',
                        'success-green': '#10b981',
                        'fail-red': '#ef4444',
                    }
                }
            }
        }

        // --- Core Business Logic (Simulating the AI Model) ---

        /**
         * Simulates the AI model's decision and generates an audit-ready justification.
         */
        function calculateDecision() {
            // 1. Collect inputs
            const name = document.getElementById('applicantName').value || 'Applicant';
            const income = parseFloat(document.getElementById('annualIncome').value) || 0;
            const existingDebt = parseFloat(document.getElementById('monthlyDebt').value) || 0;
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const creditScore = parseInt(document.getElementById('creditScore').value) || 0;
            const loanTermYears = parseInt(document.getElementById('loanTerm').value) || 0;

            const resultsDiv = document.getElementById('justificationResults');
            resultsDiv.innerHTML = ''; // Clear previous results

            if (income <= 0 || existingDebt < 0 || loanAmount <= 0 || creditScore < 300 || loanTermYears <= 0) {
                alert("Please enter valid, non-zero values for Income, Loan Amount, Credit Score, and Loan Term.");
                return;
            }
            
            // 2. Calculate Derived Metrics (Financial Soundness)
            const monthlyPaymentEst = (loanAmount / (loanTermYears * 12)) * 1.02; 
            const grossMonthlyIncome = income / 12;
            const newTotalMonthlyDebt = existingDebt + monthlyPaymentEst;
            const dtiRatio = (newTotalMonthlyDebt / grossMonthlyIncome) * 100;

            // 3. Apply Decision Logic (Underwriting Rules)
            let decision = 'DENIED';
            let decisionColor = 'fail-red';
            let rationale = 'Insufficient creditworthiness.';
            let denialReasonCode = ''; // Specific ECOA reason code

            const isCreditExcellent = creditScore >= 740;
            const isDtiExcellent = dtiRatio <= 30;
            const isDtiAcceptable = dtiRatio <= 43;

            // Primary Decision Logic (Highly Simplified for Demo)
            if (isDtiExcellent && isCreditExcellent) {
                decision = 'APPROVED';
                decisionColor = 'success-green';
                rationale = 'The borrower demonstrates exceptional financial stability and low repayment risk.';
            } else if (isDtiAcceptable && creditScore >= 680) {
                decision = 'APPROVED (Conditional)';
                decisionColor = 'primary-blue';
                rationale = 'The borrower meets standard underwriting criteria but may be subject to a higher interest rate.';
            } else {
                // DENIAL LOGIC - Generate specific, legally compliant reasons
                if (dtiRatio > 50) {
                    rationale = 'The Debt-to-Income (DTI) ratio is too high for the requested loan amount.';
                    denialReasonCode = 'A. Excessive obligations in relation to income.';
                } else if (creditScore < 600) {
                    rationale = 'Credit score is below the minimum threshold, indicating a history of poor debt management.';
                    denialReasonCode = 'B. Insufficient credit score/Credit history indicates high risk of delinquency.';
                } else if (loanAmount > (income * 0.5) && creditScore < 700) {
                     rationale = 'Requested loan amount is too large relative to annual income, despite a technically acceptable DTI.';
                    denialReasonCode = 'C. Requested loan amount exceeds policy limits based on annual income.';
                } else {
                     rationale = 'The application failed internal policy checks for unknown reasons.';
                    denialReasonCode = 'D. Failure to meet minimum established credit requirements.';
                }
            }

            // 4. Simulate XAI/SHAP Factor Analysis
            const factors = generateShapFactors(dtiRatio, creditScore, monthlyPaymentEst);

            // 5. Run Bias Audit
            const biasAudit = runBiasAudit(decision, name, dtiRatio, denialReasonCode);


            // 6. Generate Regulator Justification Report
            const report = generateRegulatorReport(decision, dtiRatio, creditScore, grossMonthlyIncome, newTotalMonthlyDebt, monthlyPaymentEst, factors, rationale, denialReasonCode);
            
            // 7. Generate Adverse Action Letter (AAN)
            const adverseActionLetter = generateAdverseActionLetter(name, denialReasonCode);

            // 8. Display Results
            displayResults(decision, decisionColor, report, factors, biasAudit, adverseActionLetter);
        }
        
        /**
         * Generates the compliant customer-facing AAN text.
         */
        function generateAdverseActionLetter(name, denialReasonCode) {
            if (denialReasonCode === '') {
                return null;
            }

            let reasonText = '';
            switch (denialReasonCode) {
                case 'A. Excessive obligations in relation to income.':
                    reasonText = "Your current debt obligations are too high in relation to your verifiable gross income.";
                    break;
                case 'B. Insufficient credit score/Credit history indicates high risk of delinquency.':
                    reasonText = "Your credit history, as reflected in your credit score, does not meet the minimum requirement for this type of loan.";
                    break;
                case 'C. Requested loan amount exceeds policy limits based on annual income.':
                    reasonText = "The loan amount requested significantly exceeds the maximum allowed based on your current annual income.";
                    break;
                case 'D. Failure to meet minimum established credit requirements.':
                default:
                    reasonText = "We are unable to approve your application due to our minimum established credit requirements.";
                    break;
            }

            return `
Dear ${name},

Thank you for applying for a loan with Banner Banking Company. We regret to inform you that we are unable to approve your application at this time.

The primary reason(s) for this adverse action decision are:

1. **${reasonText}** (${denialReasonCode.split('.')[0]})

This decision was made based on a review of your credit history and financial profile. Please note that this is NOT based on your race, color, religion, national origin, sex, marital status, or age.

Sincerely,
Banner Banking Company Compliance Officer
            `;
        }

        /**
         * Runs a simulated check for proxy bias, flagging the result if a protected group is denied by a non-financial factor.
         */
        function runBiasAudit(decision, name, dtiRatio, denialReasonCode) {
            // SIMULATION: Flag if a non-traditional/ethnic name is denied for a reason that is close to the acceptable threshold.
            // This tests the model's robustness against hidden bias.
            const suspectedBiasName = name.toLowerCase().includes('jang') || name.toLowerCase().includes('chen');
            
            if (decision.includes('DENIED') && suspectedBiasName) {
                // If denied, but DTI is close to acceptable (e.g., between 43% and 50%) AND the zip code was a negative factor (simulated in SHAP)
                if (dtiRatio > 43 && dtiRatio <= 50 && denialReasonCode === 'D. Failure to meet minimum established credit requirements.') {
                    return {
                        flagged: true,
                        message: "CRITICAL: The denial reason is ambiguous and occurred near the decision threshold. This instance requires manual review for **Disparate Impact Risk** as the decision may be a proxy for bias based on the applicant's name/demographic profile."
                    };
                }
            }
            return { flagged: false, message: "No critical proxy bias detected in this instance." };
        }

        /**
         * Simulates SHAP values (feature contribution) based on calculated metrics.
         */
        function generateShapFactors(dti, creditScore, monthlyPayment) {
            const factors = [
                { name: "Debt-to-Income (DTI) Ratio", value: dti.toFixed(1) + '%', impact: dti < 36 ? 'Positive' : (dti > 43 ? 'Negative' : 'Neutral'), description: "Key measure of repayment capacity relative to gross income." },
                { name: "FICO Score", value: creditScore, impact: creditScore >= 740 ? 'Positive' : (creditScore < 650 ? 'Negative' : 'Neutral'), description: "Indicator of past credit management and default history." },
                { name: "New Monthly Payment", value: `$${monthlyPayment.toFixed(2)}`, impact: monthlyPayment < 1500 ? 'Positive' : 'Neutral', description: "The immediate monthly financial obligation created by this loan." },
            ];

            // Introduce a bias detection proxy (e.g., zip code proxy for income stability)
            const zipCode = document.getElementById('zipCode').value;
            // Ensure zipCode is not empty before checking startswith
            if (zipCode && zipCode.startsWith('914') && creditScore > 700) {
                 factors.push({ name: "Geographic Stability Index", value: "High", impact: 'Positive', description: "Secondary factor indicating stable residential tenure." });
            } else if (zipCode && zipCode.startsWith('914') && creditScore < 650) {
                 factors.push({ name: "Geographic Stability Index", value: "Low", impact: 'Negative', description: "Secondary factor indicating potential economic volatility (PROXY RISK)." });
            }

            return factors;
        }

        /**
         * Generates the final, structured report for the regulator.
         */
        function generateRegulatorReport(decision, dti, creditScore, gmi, newDebt, monthlyPay, factors, rationale, denialReasonCode) {
            const decisionType = decision.startsWith('APPROVED') ? 'Approval' : 'Denial';
            
            let regulatoryReasonOutput = '';
            if (decisionType === 'Approval') {
                regulatoryReasonOutput = `The application was GREEN-LIT based on a holistic assessment. The primary approval driver was the *exceptionally low Debt-to-Income ratio*, which minimizes inherent repayment risk. The decision is fair, non-discriminatory, and aligns with the bank's Tier 1 lending policies.`;
            } else {
                // Use the specific denial code for the Adverse Action Notice
                regulatoryReasonOutput = `The application was RED-FLAGGED and DENIED.
    * **Specific ECOA Adverse Action Reason Code:** ${denialReasonCode}
    * **Compliance Statement:** The decision is purely based on objective financial metrics (credit, income, debt obligations), with no reliance on protected class data. This satisfies the Adverse Action Notice requirement under Regulation B (ECOA).`;
            }


            // Format the final report
            return `
RLJT MODEL VALIDATION REPORT: ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
----------------------------------------------------------------------------------------------------------------
1. FINAL MODEL DECISION: ${decision}
2. PRIMARY RATIONALE: ${rationale}

----------------------------------------------------------------------------------------------------------------
3. CORE FINANCIAL METRICS (VALIDATOR CHECK)
    > Gross Monthly Income (GMI): \$${gmi.toFixed(2)}
    > New Total Monthly Debt: \$${newDebt.toFixed(2)} (Including new loan payment of \$${monthlyPay.toFixed(2)})
    > Calculated Debt-to-Income (DTI) Ratio: ${dti.toFixed(2)}%
    > Underwriting Policy Threshold (Max DTI): 43.00%
    > Credit Score: ${creditScore}

----------------------------------------------------------------------------------------------------------------
4. XAI / FEATURE CONTRIBUTION (SHAP-STYLE ANALYSIS)
    (Proving non-biased feature usage for audit traceability)

${factors.map(f => {
    return `    - ${f.name.padEnd(30, ' ')}: ${f.impact.padEnd(8, ' ')} | Value: ${f.value} | Rationale: ${f.description}`;
}).join('\n')}

----------------------------------------------------------------------------------------------------------------
5. REGULATOR JUSTIFICATION (FAIR LENDING & AUDIT TRAIL)
    * **Fairness Check:** Decision is non-discriminatory; no protected class features contributed to the decision.
    * **Traceability:** Decision is fully reproducible using only objective inputs (DTI, Credit Score, Income).
    * **Compliance Statement:** ${regulatoryReasonOutput}
----------------------------------------------------------------------------------------------------------------
`;
        }


        function displayResults(decision, decisionColor, report, factors, biasAudit, adverseActionLetter) {
            const resultsDiv = document.getElementById('justificationResults');
            let decisionHTML = '';

            // Handle Bias Alert Display
            let biasAlertHTML = '';
            if (biasAudit.flagged) {
                decisionHTML = `
                    <div class="mb-4 p-4 rounded-lg text-center bg-yellow-600 text-white font-bold text-xl">
                        RISK ALERT: ${decision}
                    </div>
                    <div class="bias-alert p-4 rounded-lg mb-4 text-center">
                        <strong class="text-lg">BIAS PROXY FLAG!</strong><br>
                        ${biasAudit.message} <br> 
                        <span class="text-sm">MANDATORY HUMAN REVIEW REQUIRED.</span>
                    </div>
                `;
            } else {
                decisionHTML = `
                    <div class="mb-4 p-4 rounded-lg text-center ${decisionColor} text-white font-bold text-xl">
                        FINAL AI DECISION: ${decision}
                    </div>
                `;
            }
            
            // Build Feature Summary
            const factorsHTML = factors.map(f => `
                <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                    <span class="font-semibold text-gray-700">${f.name}</span>
                    <span class="text-sm ${f.impact === 'Positive' ? 'text-success-green' : (f.impact === 'Negative' ? 'text-fail-red' : 'text-gray-500')} font-mono">
                        ${f.impact} (${f.value})
                    </span>
                </div>
            `).join('');

            // Build Adverse Action Letter (only if denied)
            let adverseActionHTML = '';
            if (adverseActionLetter) {
                adverseActionHTML = `
                    <div class="bg-white p-6 rounded-lg card mt-6">
                        <h3 class="text-lg font-bold text-fail-red mb-4 border-b pb-2">ADVERSE ACTION NOTICE (AAN) - Customer Facing</h3>
                        <div class="justification-output text-gray-800 text-sm p-3 border border-red-400 rounded bg-red-50">
                            ${adverseActionLetter}
                        </div>
                        <p class="text-xs text-gray-500 mt-3 italic">This is the exact content required by Regulation B (ECOA) to be sent to the applicant after a denial.</p>
                    </div>
                `;
            }


            resultsDiv.innerHTML = `
                ${decisionHTML}

                <div class="bg-white p-6 rounded-lg card mb-6">
                    <h3 class="text-lg font-bold text-primary-blue mb-4 border-b pb-2">Feature Contribution Summary</h3>
                    ${factorsHTML}
                </div>

                <div class="bg-white p-6 rounded-lg card">
                    <h3 class="text-lg font-bold text-primary-blue mb-4 border-b pb-2">Audit-Ready Justification Report</h3>
                    <div class="justification-output text-gray-800 text-sm p-3 border border-gray-300 rounded bg-gray-50">${report}</div>
                </div>
                
                ${adverseActionHTML}
            `;
        }

        // Initialize the tool with the previously approved customer's data
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('applicantName').value = 'Dr. Amelia K. Chen';
            document.getElementById('annualIncome').value = '140000';
            document.getElementById('monthlyDebt').value = '1800';
            document.getElementById('loanAmount').value = '50000';
            document.getElementById('creditScore').value = '780';
            document.getElementById('loanTerm').value = '60'; // 5 years
            document.getElementById('zipCode').value = '91411';
            calculateDecision(); // Run initial calculation on load
        });
    </script>
</head>
<body>
    <div class="min-h-screen p-6 flex items-center justify-center">
        <div class="w-full max-w-4xl">
            <h1 class="text-3xl font-extrabold text-gray-900 text-center mb-8">
                Responsible Lending Justification Tool (RLJT)
            </h1>

            <!-- Input Card -->
            <div class="bg-white p-8 rounded-xl card mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Applicant Data Input</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <div class="input-group md:col-span-2">
                        <label for="applicantName" class="block text-sm mb-1">Applicant Name (For Bias Proxy Check)</label>
                        <input type="text" id="applicantName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>
                    </div>

                    <div class="input-group">
                        <label for="annualIncome" class="block text-sm mb-1">Annual Gross Income ($)</label>
                        <input type="number" id="annualIncome" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>
                    </div>

                    <div class="input-group">
                        <label for="monthlyDebt" class="block text-sm mb-1">Existing Monthly Debt Payments ($)</label>
                        <input type="number" id="monthlyDebt" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>
                    </div>

                    <div class="input-group">
                        <label for="creditScore" class="block text-sm mb-1">FICO Credit Score (300-850)</label>
                        <input type="number" id="creditScore" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" min="300" max="850" required>
                    </div>

                    <div class="input-group">
                        <label for="loanAmount" class="block text-sm mb-1">Requested Loan Amount ($)</label>
                        <input type="number" id="loanAmount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>
                    </div>

                    <div class="input-group">
                        <label for="loanTerm" class="block text-sm mb-1">Loan Term (Months - e.g., 60 for 5 years)</label>
                        <input type="number" id="loanTerm" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="zipCode" class="block text-sm mb-1">Applicant Zip Code (For Proxy Testing)</label>
                        <input type="text" id="zipCode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" maxlength="5">
                    </div>

                </div>

                <div class="mt-8">
                    <button onclick="calculateDecision()" class="w-full bg-primary-blue hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200">
                        Run Model & Generate Justification
                    </button>
                </div>
            </div>

            <!-- Output Area -->
            <div id="justificationResults">
                <!-- Results will be displayed here -->
            </div>
            
            <p class="text-xs text-gray-500 text-center mt-6">
                Disclaimer: This tool simulates an AI model's decision process for educational purposes only. It does not constitute legal, financial, or regulatory advice.
            </p>
        </div>
    </div>
</body>
</html>
